<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VietQR - Tạo mã QR chuyển khoản ngân hàng</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-qrcode"></i> VietQR - Tạo mã QR chuyển khoản ngân hàng</h1>
        </header>
        
        {% if error_message %}
        <div class="error-message">
            <i class="fas fa-exclamation-circle"></i> {{ error_message }}
        </div>
        {% endif %}
        
        <div class="form-container">
            <form method="POST" action="/">
                <div class="form-group">
                    <label for="bank_combo"><i class="fas fa-search"></i> Ngân hàng:</label>
                    <div class="combo-wrapper">
                        <input type="text" id="bank_combo" placeholder="Nhập tên, viết tắt, mã hoặc BIN">
                        <div id="bank_suggestions" class="suggestions"></div>
                    </div>
                    <input type="hidden" id="bank_hidden" name="bank">
                    <small id="bank_selected_hint" class="hint"></small>
                </div>
                
                <div class="form-group">
                    <label for="account_number"><i class="fas fa-credit-card"></i> Số tài khoản:</label>
                    <input type="text" id="account_number" name="account_number" required placeholder="Nhập số tài khoản">
                </div>
                
                <div class="form-group">
                    <label for="amount"><i class="fas fa-money-bill-wave"></i> Số tiền (VND):</label>
                    <input type="text" id="amount" name="amount" required placeholder="Nhập số tiền">
                </div>
                
                <div class="form-group">
                    <label for="purpose"><i class="fas fa-comment-alt"></i> Nội dung chuyển khoản:</label>
                    <input type="text" id="purpose" name="purpose" placeholder="Nhập nội dung chuyển khoản">
                </div>
                
                <div class="form-group">
                    <button type="submit"><i class="fas fa-magic"></i> Tạo mã QR</button>
                </div>
            </form>
        </div>
        
        {% if bank_info %}
        <div class="result-container">
            <h2><i class="fas fa-info-circle"></i> Thông tin chuyển khoản</h2>
            <div class="qr-info">
                <div class="qr-image">
                    <img src="{{ bank_info.qr_image }}" alt="QR Code">
                    <div class="qr-overlay">
                        <span class="qr-hint">Quét mã để thanh toán</span>
                    </div>
                </div>
                <div class="transfer-info">
                    <p><strong><i class="fas fa-university"></i> Ngân hàng:</strong> {{ bank_info.bank_name }}</p>
                    <p><strong><i class="fas fa-credit-card"></i> Số tài khoản:</strong> {{ bank_info.account_number }}</p>
                    <p><strong><i class="fas fa-money-bill-wave"></i> Số tiền:</strong> {{ bank_info.amount }} VND</p>
                    <p><strong><i class="fas fa-comment-alt"></i> Nội dung:</strong> {{ bank_info.purpose }}</p>
                </div>
            </div>
            <div class="download-section">
                <a href="{{ bank_info.poster_image }}" download="vietqr_transfer_info.png" class="download-button">
                    <i class="fas fa-download"></i> Tải ảnh thông tin chuyển khoản
                </a>
            </div>
        </div>
        {% endif %}
        
        <footer>
            <p>&copy; 2024 VietQR Generator - Tạo mã QR chuyển khoản ngân hàng dễ dàng</p>
        </footer>
    </div>
    
    <script>
        // Định dạng số tiền khi nhập
        document.getElementById('amount').addEventListener('input', function(e) {
            // Xóa tất cả ký tự không phải số
            let value = this.value.replace(/\D/g, '');
            // Định dạng với dấu phân cách hàng nghìn
            if (value !== '') {
                value = parseInt(value).toLocaleString('vi-VN');
            }
            this.value = value;
        });
        
        // Hiệu ứng khi focus vào form
        const formGroups = document.querySelectorAll('.form-group');
        formGroups.forEach(group => {
            const input = group.querySelector('input, select');
            if (input) {
                input.addEventListener('focus', () => {
                    group.classList.add('focused');
                });
                input.addEventListener('blur', () => {
                    group.classList.remove('focused');
                });
            }
        });

        // Ô gộp tìm kiếm + dropdown tùy biến -> set giá trị ẩn 'bank'
        const bankData = {{ banks | tojson }};
        const bankInput = document.getElementById('bank_combo');
        const bankHidden = document.getElementById('bank_hidden');
        const bankHint = document.getElementById('bank_selected_hint');
        const submitBtn = document.querySelector('button[type="submit"]');
        const suggestionsEl = document.getElementById('bank_suggestions');
        let currentList = [];
        let activeIndex = -1;

        function normalize(str) {
            return (str || '')
                .toString()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase();
        }

        function resolveBankShortName(text) {
            const n = normalize(text);
            // Nếu nhập theo định dạng "Tên (SHORT)"
            const matchParen = /\(([^)]+)\)/.exec(text);
            if (matchParen && matchParen[1]) {
                return matchParen[1];
            }
            for (const b of bankData) {
                const fields = [b.name, b.shortName, b.code, b.bin].map(normalize);
                if (fields.some(f => f === n || (n && f.includes(n)))) {
                    return b.shortName;
                }
            }
            return '';
        }

        function updateSelection() {
            const sn = resolveBankShortName(bankInput.value);
            if (sn) {
                bankHidden.value = sn;
                submitBtn.disabled = false;
                const b = bankData.find(x => x.shortName.toLowerCase() === sn.toLowerCase());
                bankHint.textContent = b ? `Đã chọn: ${b.name} (${b.shortName})` : '';
                bankHint.style.color = '#1976d2';
            } else {
                bankHidden.value = '';
                submitBtn.disabled = true;
                bankHint.textContent = bankInput.value ? 'Chưa xác định ngân hàng hợp lệ' : '';
                bankHint.style.color = '#d32f2f';
            }
        }

        function renderSuggestions(list) {
            currentList = list.slice(0, 10);
            suggestionsEl.innerHTML = '';
            if (currentList.length === 0) {
                suggestionsEl.classList.remove('show');
                return;
            }
            currentList.forEach((b, i) => {
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `
                    <span class="icon"><i class="fas fa-university"></i></span>
                    <div class="title">${b.name} <span class="short">(${b.shortName})</span></div>
                    <div class="meta">BIN ${b.bin}</div>
                `;
                item.addEventListener('click', () => selectBank(b));
                suggestionsEl.appendChild(item);
            });
            suggestionsEl.classList.add('show');
            activeIndex = 0;
            highlightActive();
        }

        function highlightActive() {
            const items = suggestionsEl.querySelectorAll('.item');
            items.forEach((el, idx) => el.classList.toggle('active', idx === activeIndex));
            const active = items[activeIndex];
            if (active) {
                const top = active.offsetTop - 20;
                suggestionsEl.scrollTo({ top, behavior: 'smooth' });
            }
        }

        function selectBank(b) {
            bankInput.value = `${b.name} (${b.shortName})`;
            bankHidden.value = b.shortName;
            submitBtn.disabled = false;
            bankHint.textContent = `Đã chọn: ${b.name} (${b.shortName})`;
            bankHint.style.color = '#1976d2';
            suggestionsEl.classList.remove('show');
        }

        bankInput.addEventListener('input', (e) => {
            const q = normalize(e.target.value);
            if (!q) {
                suggestionsEl.classList.remove('show');
                updateSelection();
                return;
            }
            const filtered = bankData.filter(b => {
                const fields = [b.name, b.shortName, b.code, b.bin].map(normalize);
                return fields.some(f => f.includes(q));
            });
            renderSuggestions(filtered);
            updateSelection();
        });

        bankInput.addEventListener('keydown', (e) => {
            const items = suggestionsEl.querySelectorAll('.item');
            if (!items.length) return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                activeIndex = Math.min(activeIndex + 1, items.length - 1);
                highlightActive();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                activeIndex = Math.max(activeIndex - 1, 0);
                highlightActive();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                const b = currentList[activeIndex];
                if (b) selectBank(b);
            } else if (e.key === 'Escape') {
                suggestionsEl.classList.remove('show');
            }
        });

        document.addEventListener('click', (e) => {
            const wrapper = document.querySelector('.combo-wrapper');
            if (wrapper && !wrapper.contains(e.target)) {
                suggestionsEl.classList.remove('show');
            }
        });

        bankInput.addEventListener('change', updateSelection);
        updateSelection();
    </script>
</body>
</html>